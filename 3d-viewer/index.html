<!DOCTYPE html>
<html style="width: 100%; height: 100%">
  <head>
    <title>3D Viewer for TagSpaces</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <link href="libs/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../legacy/theming.css" />
    <style>
      .modal-backdrop {
        z-index: -1;
      }
      body {
        background-color: transparent;
      }
    </style>
    <script src="libs/file-saver/FileSaver.min.js"></script>
    <script src="libs/bootstrap/bootstrap.bundle.min.js"></script>
    <script type="module" src="libs/model-viewer/model-viewer.min.js"></script>
    <script>
      function getParameterByName(paramName) {
        const name = paramName.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        let param =
          results === null
            ? ''
            : decodeURIComponent(results[1].replace(/\+/g, ' '));
        if (param.includes('#')) {
          param = param.split('#').join('%23');
        }
        return param;
      }

      function dataURItoBlob(dataURI) {
        // convert base64 to raw binary data held in a string
        // doesn't handle URLEncoded DataURIs - see SO answer #6850276 for code that does this
        var byteString = atob(dataURI.split(',')[1]);

        // separate out the mime component
        var mimeString = dataURI
          .split(',')[0]
          .split(':')[1]
          .split(';')[0];

        // write the bytes of the string to an ArrayBuffer
        var ab = new ArrayBuffer(byteString.length);

        // create a view into the buffer
        var ia = new Uint8Array(ab);

        // set the bytes of the buffer to the correct values
        for (var i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
        }

        // write the ArrayBuffer to a blob, and you're done
        var blob = new Blob([ab], { type: mimeString });
        return blob;
      }

      const filePath = getParameterByName('file');
      const isWeb =
        (document.URL.startsWith('http') &&
          !document.URL.startsWith('http://localhost:1212/')) ||
        filePath.startsWith('http');

      document.onreadystatechange = () => {
        if (document.readyState === 'complete') {
          const modelViewer = document.querySelector('model-viewer');
          modelViewer.src = isWeb ? filePath : 'file://' + filePath;
        }

        const screenshotModal = new bootstrap.Modal('#screenshotModal', {});
        const viewer3D = document.querySelector('model-viewer');

        document
          .getElementById('printMenuItem')
          .addEventListener('click', () => {
            setTimeout(() => {
              window.print();
            }, 300);
          });

        document
          .getElementById('screenshotMenuItem')
          .addEventListener('click', () => {
            const screenshotURL = viewer3D.toDataURL('image/png');
            const imageEl = document.getElementById('screenshotImg');
            imageEl.setAttribute('src', screenshotURL);
            screenshotModal.show();

            // const viewer3D = document.createElement('model-viewer');
            // // viewer3D.setAttribute('style', 'left: -10000px;');
            // viewer3D.src =
            //   'file:///home/na/Desktop/3D-Models/apollo_exterior-150k-4096.glb';
            // viewer3D.addEventListener('load', () => {
            //   const screenshotURL = viewer3D.toDataURL('image/jpg');
            //   const imageEl = document.getElementById('screenshotImg');
            //   imageEl.setAttribute('src', screenshotURL);
            // });
            // document.body.appendChild(viewer3D);
          });

        document
          .getElementById('saveScreenshotButton')
          .addEventListener('click', () => {
            const imageEl = document.getElementById('screenshotImg');
            fetch(imageEl.src)
              .then(res => res.blob())
              .then(blob => {
                FileSaver.saveAs(blob, 'Screenshot3DModel.png');
              });
            // FileSaver.saveAs(
            //   dataURItoBlob(imageEl.src),
            //   'Screenshot3DModel.png'
            // );
            screenshotModal.hide();
          });
      };
    </script>
  </head>
  <body style="width: 100%; height: 100%; overflow: hidden; margin: 0;">
    <model-viewer
      style="width: 100%; height: 100%"
      ar
      shadow-intensity="1"
      camera-controls
      touch-action="pan-y"
    >
      <div
        class="btn-group dropup-center dropup"
        style="position: absolute; right: 20px; bottom: 20px;"
      >
        <button
          type="button"
          class="btn btn-primary  btn-lg"
          data-bs-toggle="dropdown"
          aria-expanded="false"
          style="border-radius: 30px; font-weight: bolder; height: 50px"
        >
          â‹®
        </button>
        <ul class="dropdown-menu">
          <li>
            <a id="screenshotMenuItem" class="dropdown-item" href="#"
              >Take Screenshot</a
            >
          </li>
          <li>
            <a id="printMenuItem" class="dropdown-item" href="#">Print</a>
          </li>
          <li><hr class="dropdown-divider" /></li>
          <li>
            <a
              class="dropdown-item"
              href="#"
              data-bs-toggle="modal"
              data-bs-target="#aboutModal"
              >About</a
            >
          </li>
        </ul>
      </div>
    </model-viewer>
    <div
      class="modal fade"
      id="aboutModal"
      tabindex="-1"
      aria-labelledby="aboutModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="aboutModalLabel">
              About 3D Viewer
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            Please visit the dedicated <a>extension page</a> in our
            documentation for more details.
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              data-bs-dismiss="modal"
            >
              Ok
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="screenshotModal"
      tabindex="-1"
      aria-labelledby="screenshotModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="screenshotModalLabel">
              Screenshot
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <img
              id="screenshotImg"
              style="max-width: 100%; max-height: 300px; display: block; margin: 0 auto;"
              alt="Screenshot of the 3D model"
            />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn" data-bs-dismiss="modal">
              Cancel
            </button>
            <button
              type="button"
              id="saveScreenshotButton"
              class="btn btn-primary"
            >
              Save
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
