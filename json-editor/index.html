<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>JSON Viewer and Editor for TagSpaces</title>
    <link rel="stylesheet" href="../libs/bootstrap5/bootstrap.min.css" />
    <link rel="stylesheet" href="libs/jsoneditor/jsoneditor.min.css" />
    <link rel="stylesheet" href="../common/common.css" />
    <style>
      :root {
        --json-zoom-level: 100%;
      }
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: auto;
        background-color: var(--default-background-color);
      }
      #documentContent {
        width: 100%;
        height: 100%;
        /* Use zoom with a fallback for better browser support */
        zoom: var(--json-zoom-level);
      }
      .jsoneditor {
        border: 0 !important;
      }
      /* Ensure the editor menu stays accessible during zoom */
      .jsoneditor-menu {
        zoom: 1 !important;
      }
      .jsoneditor-outer {
        height: calc(100% - 10px) !important;
      }
    </style>
    <script src="libs/jsoneditor/jsoneditor-minimalist.min.js"></script>
    <script src="../libs/dompurify/dist/purify.min.js"></script>
    <script src="../libs/bootstrap5/bootstrap.bundle.min.js"></script>
    <script src="../libs/i18next/i18next.min.js"></script>
    <script src="../common/common.js"></script>
    <script>
      const filePath = getParameterByName('file');
      let locale = getParameterByName('locale') || 'en';
      if (locale === 'en') locale = 'en_US';

      let jsonEditor;
      let isViewer = true;
      let zoomLevel = 100;

      document.addEventListener('DOMContentLoaded', () => {
        setupUI();
        sendMessageToHost({ command: 'loadDefaultTextContent' });
      });

      function setupUI() {
        insertAboutDialog('https://docs.tagspaces.org/extensions/json-editor');
        insertPrintMenuItem();
        insertZoomContentMenuItem();
        initI18N(locale, 'ns.extension.json');

        // Load and apply settings
        const extSettings = loadExtSettings('jsonEditorSettings');
        if (extSettings && extSettings.zoomLevel) {
          zoomLevel = Math.min(Math.max(extSettings.zoomLevel, 30), 500);
        }
        applyZoom();

        // Zoom Event Listeners
        document
          .getElementById('zoomInButton')
          ?.addEventListener('click', (e) => {
            e.stopPropagation();
            zoomLevel = Math.min(zoomLevel + 10, 500);
            updateZoom();
          });

        document
          .getElementById('zoomOutButton')
          ?.addEventListener('click', (e) => {
            e.stopPropagation();
            zoomLevel = Math.max(zoomLevel - 10, 30);
            updateZoom();
          });

        document
          .getElementById('zoomResetButton')
          ?.addEventListener('click', (e) => {
            e.stopPropagation();
            zoomLevel = 100;
            updateZoom();
          });
      }

      function updateZoom() {
        saveExtSettings('jsonEditorSettings', { zoomLevel });
        applyZoom();
      }

      function applyZoom() {
        document.documentElement.style.setProperty(
          '--json-zoom-level',
          zoomLevel + '%',
        );
      }

      /**
       * Notifies host that content has changed
       */
      function contentChanged() {
        sendMessageToHost({
          command: 'contentChangedInEditor',
          filepath: filePath,
        });
      }

      /**
       * Returns current JSON content to TagSpaces host for saving
       */
      function getContent() {
        if (jsonEditor) {
          try {
            return JSON.stringify(jsonEditor.get(), null, 2);
          } catch (e) {
            console.error('Error getting content from editor', e);
          }
        }
        return '';
      }

      /**
       * Main entry point for loading content
       */
      function setContent(jsonContentParam, filePathParam, isViewMode) {
        let jsonContent = jsonContentParam;

        // Strip UTF-8 BOM
        if (jsonContent.startsWith('\ufeff')) {
          jsonContent = jsonContent.substring(1);
        }

        let parsedData;
        try {
          // SECURE PARSING: The "reviver" function checks every key
          parsedData = JSON.parse(jsonContent, (key, value) => {
            if (key === '__proto__' || key === 'constructor') {
              throw new Error(
                `Security Violation: Dangerous key "${key}" detected.`,
              );
            }
            return value;
          });
        } catch (e) {
          const container = document.getElementById('documentContent');

          // Check if it was a security error or a syntax error
          const isSecurityError = e.message.includes('Security Violation');
          const errorMsg = isSecurityError
            ? e.message
            : `Invalid JSON syntax: ${e.message}`;

          container.innerHTML = DOMPurify.sanitize(
            `<div class="alert ${isSecurityError ? 'alert-dark' : 'alert-danger'} m-3">
         <h4 class="alert-heading">${isSecurityError ? 'üîí Security Block' : '‚ùå Parsing Error'}</h4>
         <p>${errorMsg}</p>
         <hr>
         <p class="mb-0 small text-muted">The document was blocked to prevent potential malicious script execution.</p>
       </div>`,
          );
          return false; // STOP EXECUTION
        }

        isViewer = isViewMode;
        const container = document.getElementById('documentContent');

        const options = {
          mode: isViewer ? 'view' : 'tree',
          search: true,
          history: true,
          // Security: prevent execution of scripts if the editor renders certain fields as HTML
          onError: (err) => {
            console.warn('JSONEditor Error:', err.toString());
          },
          onChange: () => {
            if (!isViewer) contentChanged();
          },
          onModeChange: (newMode) => {
            isViewer = newMode === 'view';
          },
        };

        // Cleanup existing instance if any
        if (jsonEditor) {
          jsonEditor.destroy();
        }

        // Validate data type before initializing
        if (
          parsedData !== null &&
          (typeof parsedData === 'object' || Array.isArray(parsedData))
        ) {
          jsonEditor = new JSONEditor(container, options, parsedData);

          if (isViewer) {
            container.addEventListener('dblclick', handleDblClick);
          } else {
            setupKeyboardShortcuts();
          }
        } else {
          container.innerHTML = `<div class="alert alert-warning m-3">The file contains valid JSON, but it is not an object or array.</div>`;
        }
      }

      function handleDblClick() {
        if (isViewer) {
          sendMessageToHost({ command: 'editDocument' });
        }
      }

      function setupKeyboardShortcuts() {
        document.body.addEventListener('keydown', (event) => {
          if (
            (event.ctrlKey || event.metaKey) &&
            event.key.toLowerCase() === 's'
          ) {
            event.stopPropagation();
            event.preventDefault();
            sendMessageToHost({ command: 'saveDocument' });
          }
        });
      }

      // Hook for viewer mode toggling from TagSpaces
      function viewerMode(isViewerMode) {
        if (jsonEditor) {
          isViewer = isViewerMode;
          jsonEditor.setMode(isViewerMode ? 'view' : 'tree');
          if (!isViewerMode) setupKeyboardShortcuts();
        }
      }
    </script>
  </head>
  <body>
    <div id="documentContent"></div>
    <div id="aboutDialogPlaceholder"></div>
    <div id="extFabMenu" class="btn-group dropup-center dropup">
      <button
        type="button"
        class="btn btn-primary btn-lg shadow"
        data-bs-toggle="dropdown"
        aria-expanded="false"
      >
        <svg class="bi" width="24" height="24" fill="currentColor">
          <path
            d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"
          ></path>
        </svg>
      </button>
      <ul class="dropdown-menu shadow">
        <li id="zoomContentMenuItemPlaceholder"></li>
        <li><hr class="dropdown-divider" /></li>
        <li id="printMenuItemPlaceholder"></li>
        <li><hr class="dropdown-divider" /></li>
        <li id="aboutMenuItemPlaceholder"></li>
      </ul>
    </div>
  </body>
</html>
