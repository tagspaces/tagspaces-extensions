<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>RTF Viewer for TagSpaces</title>

    <link rel="stylesheet" href="../libs/bootstrap5/bootstrap.min.css" />
    <link rel="stylesheet" href="../common/common.css" />

    <style>
      :root {
        --rtf-zoom: 100%;
      }
      body {
        overflow: auto;
        background-color: var(--background-color);
      }
      #documentWrapper {
        display: flex;
        justify-content: center;
        padding: 20px;
      }
      #documentContent {
        color: var(--text-color);
        background-color: var(--background-color);
        /* box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); */
        padding: 20px;
        min-height: 297mm;
        width: 100%;
        max-width: 1280px;
        margin: 0 auto;
        zoom: var(--rtf-zoom);
        transform-origin: top center;
        word-wrap: break-word;
      }
      .error-overlay {
        padding: 20px;
        background-color: #f8d7da;
        border: 1px solid #f5c2c7;
        margin: 20px;
        border-radius: 4px;
      }
      #documentContent img,
      #documentContent svg {
        max-width: 100%;
        height: auto;
      }
    </style>

    <script src="../libs/mark.js/mark.min.js"></script>
    <script src="../libs/dompurify/dist/purify.min.js"></script>
    <script src="libs/rtf/RTFJS.bundle.min.js"></script>
    <script src="../libs/bootstrap5/bootstrap.bundle.min.js"></script>
    <script src="../libs/i18next/i18next.min.js"></script>
    <script src="../common/common.js"></script>

    <script>
      const filePath = getParameterByName('file');
      const locale = (getParameterByName('locale') || 'en').replace(
        'en',
        'en_US',
      );
      const encrypted = getParameterByName('encrypted');
      let zoomLevel = 100;

      document.addEventListener('DOMContentLoaded', initExtension);

      async function initExtension() {
        insertAboutDialog('https://docs.tagspaces.org/extensions/rtf-viewer');
        insertPrintMenuItem();
        insertToggleFindMenuItem();
        insertZoomContentMenuItem();
        insertExportAsHTMLFunctionality();
        initI18N(locale, 'ns.extension.json');

        const settings = loadExtSettings('rtfViewerSettings') || {};
        zoomLevel = settings.zoomLevel || 100;
        updateZoom(zoomLevel);

        // Global Click Listener (including link hijacking)
        document.addEventListener('click', (e) => {
          const id = e.target.closest('button')?.id || e.target.id;

          // Handle Zoom UI
          if (id === 'zoomInButton') updateZoom(zoomLevel + 10);
          if (id === 'zoomOutButton') updateZoom(zoomLevel - 10);
          if (id === 'zoomResetButton') updateZoom(100);

          // Show Properties Modal
          if (e.target.id === 'showMetaBtn') {
            e.preventDefault();
            const modalEl = document.getElementById('metaModal');
            bootstrap.Modal.getOrCreateInstance(modalEl).show();
          }

          // Intercept all <a> tag clicks inside #documentContent
          const link = e.target.closest('#documentContent a');
          if (link) {
            e.preventDefault();
            const url = link.getAttribute('href');
            if (url && url !== '#' && !url.startsWith('javascript:')) {
              console.log('Opening link externally:', url);
              sendMessageToHost({ command: 'openLinkExternally', link: url });
            }
          }
        });

        if (encrypted) {
          sendMessageToHost({ command: 'loadDefaultTextContent' });
        } else {
          try {
            const content = await getFileContentPromise(
              filePath,
              'arraybuffer',
            );
            await processRTF(content);
          } catch (e) {
            handleError('Failed to load file: ' + e.message);
          }
        }
      }

      function updateZoom(val) {
        zoomLevel = Math.min(Math.max(val, 30), 500);
        document.documentElement.style.setProperty(
          '--rtf-zoom',
          zoomLevel + '%',
        );
        saveExtSettings('rtfViewerSettings', { zoomLevel });
      }

      async function processRTF(data) {
        const contentArea = document.getElementById('documentContent');
        const metaBody = document.getElementById('metaBody');

        try {
          const doc = new RTFJS.Document(data, {
            // This hook still helps by ensuring URL data is preserved in the rendered HTML
            onHyperlink: (create, hyperlink) => {
              const url = hyperlink.url();
              const lnk = create();
              lnk.setAttribute('href', url);
              return { content: lnk, element: lnk };
            },
          });

          // Metadata Handling
          const meta = doc.metadata();
          metaBody.innerHTML = '';
          let hasMeta = false;
          for (const key in meta) {
            const metaEntry = document.createElement('div');
            metaEntry.className = 'mb-2';
            metaEntry.innerHTML = `<strong>${DOMPurify.sanitize(key)}:</strong><br>${DOMPurify.sanitize(meta[key].toString())}`;
            metaBody.appendChild(metaEntry);
            hasMeta = true;
          }
          if (!hasMeta)
            document.getElementById('showMetaBtn').parentElement.style.display =
              'none';

          // Rendering
          const elements = await doc.render();
          const wrapper = document.createElement('div');

          if (Array.isArray(elements)) {
            elements.forEach((el) => wrapper.appendChild(el));
          } else {
            wrapper.appendChild(elements);
          }

          // Clean HTML while preserving styles and SVG data
          const cleanHtml = DOMPurify.sanitize(wrapper.innerHTML, {
            ALLOW_UNKNOWN_PROTOCOLS: true,
            ADD_TAGS: [
              'svg',
              'use',
              'image',
              'path',
              'rect',
              'circle',
              'ellipse',
              'line',
              'polyline',
              'polygon',
            ],
            ADD_ATTR: [
              'xlink:href',
              'target',
              'viewBox',
              'fill',
              'stroke',
              'style',
            ],
          });

          if (cleanHtml && cleanHtml.trim().length > 0) {
            contentArea.innerHTML = cleanHtml;
          } else {
            contentArea.innerHTML =
              '<p class="text-muted text-center mt-5">The document has no displayable content.</p>';
          }

          if (typeof initFindToolbar === 'function') initFindToolbar();
        } catch (error) {
          handleError(error.message || 'Error parsing RTF content');
        }
      }

      function handleError(msg) {
        document.getElementById('documentContent').innerHTML = `
          <div class="error-overlay">
            <h5>Viewer Error</h5>
            <p>${DOMPurify.sanitize(msg)}</p>
          </div>
        `;
      }

      function setContent(content) {
        const encoder = new TextEncoder();
        processRTF(encoder.encode(content).buffer);
      }
    </script>
  </head>
  <body>
    <div id="findToolbarPlaceholder"></div>

    <div id="documentWrapper">
      <div id="documentContent">
        <div class="text-center mt-5">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2 text-muted">Rendering document...</p>
        </div>
      </div>
    </div>

    <!-- Properties Modal -->
    <div class="modal fade" id="metaModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Document Properties</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div id="metaBody" class="modal-body small"></div>
        </div>
      </div>
    </div>

    <div id="aboutDialogPlaceholder"></div>

    <div id="extFabMenu" class="btn-group dropup-center dropup">
      <button
        type="button"
        class="btn btn-primary btn-lg"
        data-bs-toggle="dropdown"
        aria-expanded="false"
      >
        <svg
          class="bi"
          width="24"
          height="24"
          focusable="false"
          aria-hidden="true"
        >
          <path
            d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"
          ></path>
        </svg>
      </button>
      <ul class="dropdown-menu shadow">
        <li id="zoomContentMenuItemPlaceholder"></li>
        <li><hr class="dropdown-divider" /></li>
        <li>
          <a class="dropdown-item" href="#" id="showMetaBtn">
            <svg width="24" height="24" class="bi" style="margin-right: 8px">
              <path
                d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.89-2-2-2zm0 16H5V7h14v12zm-2-7H7v-2h10v2zm-4 4H7v-2h6v2z"
              ></path></svg
            >Document Properties</a
          >
        </li>
        <li id="exportAsHTMLMenuItemPlaceholder"></li>
        <li id="toggleFindMenuItemPlaceholder"></li>
        <li id="printMenuItemPlaceholder"></li>
        <li><hr class="dropdown-divider" /></li>
        <li id="aboutMenuItemPlaceholder"></li>
      </ul>
    </div>
  </body>
</html>
